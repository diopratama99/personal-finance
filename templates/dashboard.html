{% extends "base.html" %}

{% block head_extra %}
  <!-- Chart.js (global, 1x) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}

<!-- FILTER PERIODE + EXPORT -->
<div class="card-soft mb-3">
  <form class="row gy-2 gx-2 align-items-end filter-grid" method="get">
    <div class="col-auto">
      <label class="form-label mb-0">Mulai</label>
      <input type="date" class="form-control" name="start" value="{{ start }}">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Selesai</label>
      <input type="date" class="form-control" name="end" value="{{ end }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Tampilkan</button>
    </div>
    <div class="col-auto ms-auto">
      <a class="btn btn-outline-primary" href="{{ url_for('import_export', start=start, end=end) }}">
        üîÅ Import/Export
      </a>
    </div>
  </form>
</div>

<!-- RINGKASAN & GRAFIK -->
<div class="row g-3 align-items-stretch equal-row">
  <div class="col-lg-4">
    <div class="card-soft h-100">
      <h6 class="text-muted">Ringkasan Periode</h6>
      <div class="display-6 fw-semibold mt-2 count-up" data-target="{{ summary.income }}">Pendapatan: {{ summary.income|money }}</div>
      <div class="display-6 fw-semibold text-danger count-up" data-target="{{ summary.expense }}">Pengeluaran: {{ summary.expense|money }}</div>
      <div class="display-6 fw-semibold {{ 'text-success' if summary.net>=0 else 'text-danger' }} count-up" data-target="{{ summary.net }}">Saldo: {{ summary.net|money }}</div>

      <hr>
      <h6 class="text-muted">Statistik Pengeluaran</h6>
      {% if spend_by_cat %}
        <p>Kategori terbanyak: <b>{{ spend_by_cat[0].category }}</b> ({{ spend_by_cat[0].total|money }})</p>
      {% else %}
        <p>Belum ada data.</p>
      {% endif %}
      {% if top_payee %}
        <p>Terbanyak ke: <b>{{ top_payee.payee }}</b> ({{ top_payee.total|money }}, {{ top_payee.cnt }} trx)</p>
      {% endif %}
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card-soft h-100">
      <h6 class="mb-3">Grafik Pengeluaran per Kategori</h6>
      <div class="chart-box" id="expenseChartBox">
        <canvas id="expenseChart" aria-label="Grafik pengeluaran per kategori" role="img"></canvas>
      </div>
    </div>
  </div>
</div>

{% if budgets %}
<div class="card-soft mt-3">
  <h6 class="mb-3">Budget Bulan {{ start[:7] }}</h6>
  {% for b in budgets %}
    {% set pct = (100 * b.spent / b.amount) if b.amount else 0 %}
    <div class="mb-2">
      <div class="d-flex justify-content-between small">
        <span>{{ b.category }}</span>
        <span>{{ b.spent|money }} / {{ b.amount|money }}</span>
      </div>
      <div class="progress budget" aria-label="Progress budget {{ b.category }}">
        <div class="progress-bar {{ 'bg-danger' if pct>100 else 'bg-success' }}"
             role="progressbar"
             style="width: {{ [pct,150]|min }}%"
             aria-valuenow="{{ pct|round|int }}" aria-valuemin="0" aria-valuemax="150"></div>
      </div>
    </div>
  {% endfor %}
  <a class="btn btn-light btn-sm mt-2" href="{{ url_for('budgets_page', month=start[:7]) }}">Kelola Budget</a>
</div>
{% endif %}

<!-- 10 TRANSAKSI TERAKHIR -->
<div class="card-soft mt-3">
  <h6 class="mb-3">10 Transaksi Terakhir</h6>
  <div class="table-responsive">
    <table class="table table-hover align-middle table-stacked">
      <thead>
        <tr>
          <th scope="col">Tanggal</th>
          <th scope="col">Jenis</th>
          <th scope="col">Kategori</th>
          <th scope="col">Nominal</th>
          <th scope="col" class="d-none d-md-table-cell">Metode</th>
          <th scope="col" class="d-none d-md-table-cell">Keterangan</th>
          <th scope="col" class="d-none d-md-table-cell">Catatan</th>
        </tr>
      </thead>
      <tbody>
        {% for t in latest %}
        <tr>
          <td data-label="Tanggal">{{ t.date }}</td>
          <td data-label="Jenis" class="{{ 'text-success' if t.type=='income' else 'text-danger' }}">{{ t.type | type_label }}</td>
          <td data-label="Kategori">{{ (t.category_emoji ~ ' ') if t.category_emoji else '' }}{{ t.category }}</td>
          <td data-label="Nominal">{{ t.amount|money }}</td>
          <td data-label="Metode" class="d-none d-md-table-cell">{{ t.payment_method or '-' }}</td>
          <td data-label="Keterangan" class="d-none d-md-table-cell">{{ t.keterangan or '-' }}</td>
          <td data-label="Catatan" class="d-none d-md-table-cell">{{ t.notes or '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block body_extra %}
<script>
  // Simpan chart instance supaya tidak double saat re-init
  let expenseChartInstance = null;

  // Animasi count-up sederhana (opsional)
  function runCountUp() {
    const els = document.querySelectorAll('.count-up');
    els.forEach(el => {
      const target = Number(el.dataset.target || 0);
      const start = 0;
      const dur = 700;
      const t0 = performance.now();
      function tick(t){
        const p = Math.min(1, (t - t0) / dur);
        const val = Math.round(start + (target - start) * p);
        const formatted = val.toLocaleString('id-ID');
        el.innerHTML = el.innerHTML.replace(/: .+$/, `: Rp ${formatted}`);
        if (p < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }

  function renderExpenseChart() {
    const canvas = document.getElementById('expenseChart');
    const box = document.getElementById('expenseChartBox');
    if (!box) return;

    // Data dari server (aman saat kosong)
    const raw = {{ (spend_by_cat if spend_by_cat is defined else [])|tojson }};

    // Hapus chart lama bila ada
    if (expenseChartInstance) {
      expenseChartInstance.destroy();
      expenseChartInstance = null;
    }

    // Bersihkan placeholder jika ada
    const prevEmpty = box.querySelector('.chart-empty');
    if (prevEmpty) prevEmpty.remove();

    if (canvas && Array.isArray(raw) && raw.length > 0 && window.Chart) {
      const ctx = canvas.getContext('2d');
      const labels = raw.map(r => r.category);
      const values = raw.map(r => Number(r.total) || 0);

      const rgb = getComputedStyle(document.documentElement)
                  .getPropertyValue('--chart-bar').trim() || '45,156,219';
      const bg = ctx.createLinearGradient(0,0,0,canvas.height);
      bg.addColorStop(0, `rgba(${rgb}, .55)`);
      bg.addColorStop(1, `rgba(${rgb}, .15)`);

      expenseChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Pengeluaran (Rp)',
            data: values,
            backgroundColor: bg,
            borderRadius: 8,
            maxBarThickness: 48
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: (v) => 'Rp ' + Number(v).toLocaleString('id-ID') }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c)=> 'Rp ' + Number(c.raw).toLocaleString('id-ID') } }
          },
          animation: { duration: 800, easing: 'easeOutQuart' }
        }
      });
    } else {
      // Tampilkan placeholder bila tidak ada data (tanpa merusak container)
      const empty = document.createElement('div');
      empty.className = 'chart-empty text-muted d-flex align-items-center justify-content-center h-100';
      empty.textContent = 'Tidak ada data pengeluaran pada periode ini.';
      box.innerHTML = ''; // kosongkan box lalu taruh placeholder
      box.appendChild(empty);
    }
  }

  // Dipanggil dari base.html (on page enter)
  window.pageInit = function(/*fromBFCache*/) {
    renderExpenseChart();
    runCountUp();
  };
</script>
{% endblock %}
