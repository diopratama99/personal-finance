{% extends "base.html" %}

{% block head_extra %}
  <!-- Chart.js (global, 1x) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}

<!-- FILTER PERIODE + EXPORT -->
<div class="card-soft mb-3">
  <form class="row gy-2 gx-2 align-items-end filter-grid" method="get">
    <div class="col-auto">
      <label class="form-label mb-0">Mulai</label>
      <input type="date" class="form-control" name="start" value="{{ start }}">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Selesai</label>
      <input type="date" class="form-control" name="end" value="{{ end }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Tampilkan</button>
    </div>
    <div class="col-auto ms-auto">
      <a class="btn btn-outline-primary" href="{{ url_for('import_export', start=start, end=end) }}">
        üîÅ Import/Export
      </a>
    </div>
  </form>
</div>

<!-- RINGKASAN & GRAFIK -->
<div class="row g-3 align-items-stretch equal-row">
  <div class="col-lg-4">
    <div class="card-soft h-100">
      <h6 class="text-muted">Ringkasan Periode</h6>
      <div class="display-6 fw-semibold mt-2 count-up" data-target="{{ summary.income }}">Pendapatan: {{ summary.income|money }}</div>
      <div class="display-6 fw-semibold text-danger count-up" data-target="{{ summary.expense }}">Pengeluaran: {{ summary.expense|money }}</div>
      <div class="display-6 fw-semibold {{ 'text-success' if summary.net>=0 else 'text-danger' }} count-up" data-target="{{ summary.net }}">Saldo: {{ summary.net|money }}</div>

      <hr>
      <h6 class="text-muted">Statistik Pengeluaran</h6>
      {% if spend_by_cat %}
        <p>Kategori terbanyak: <b>{{ spend_by_cat[0].category }}</b> ({{ spend_by_cat[0].total|money }})</p>
      {% else %}
        <p>Belum ada data.</p>
      {% endif %}
      {% if top_payee %}
        <p>Terbanyak ke: <b>{{ top_payee.payee }}</b> ({{ top_payee.total|money }}, {{ top_payee.cnt }} trx)</p>
      {% endif %}
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card-soft h-100">
      <h6 class="mb-3">Grafik Pengeluaran per Kategori</h6>
      <div class="chart-box">
        <canvas id="expenseChart"></canvas>
      </div>
    </div>
  </div>
</div>

{% if budgets %}
<div class="card-soft mt-3">
  <h6 class="mb-3">Budget Bulan {{ start[:7] }}</h6>
  {% for b in budgets %}
    {% set pct = (100 * b.spent / b.amount) if b.amount else 0 %}
    <div class="mb-2">
      <div class="d-flex justify-content-between small">
        <span>{{ b.category }}</span>
        <span>{{ b.spent|money }} / {{ b.amount|money }}</span>
      </div>
      <div class="progress budget">
        <div class="progress-bar {{ 'bg-danger' if pct>100 else 'bg-success' }}" role="progressbar" style="width: {{ [pct,150]|min }}%"></div>
      </div>
    </div>
  {% endfor %}
  <a class="btn btn-light btn-sm mt-2" href="{{ url_for('budgets_page', month=start[:7]) }}">Kelola Budget</a>
</div>
{% endif %}

<!-- 10 TRANSAKSI TERAKHIR -->
<div class="card-soft mt-3">
  <h6 class="mb-3">10 Transaksi Terakhir</h6>
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr><th>Tanggal</th><th>Jenis</th><th>Kategori</th><th>Nominal</th><th>Metode</th><th>Keterangan</th><th>Catatan</th></tr>
      </thead>
      <tbody>
        {% for t in latest %}
        <tr>
          <td>{{ t.date }}</td>
          <td class="{{ 'text-success' if t.type=='income' else 'text-danger' }}">{{ t.type }}</td>
          <td>{{ t.category }}</td>
          <td>{{ t.amount|money }}</td>
          <td>{{ t.payment_method or '-' }}</td>
          <td>{{ t.keterangan or '-' }}</td>
          <td>{{ t.notes or '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block body_extra %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Data dari server
  const raw = {{ (spend_by_cat if spend_by_cat is defined else [])|tojson }};
  const canvas = document.getElementById('expenseChart');
  if (!canvas || !window.Chart) return;

  if (Array.isArray(raw) && raw.length > 0) {
    const labels = raw.map(r => r.category);
    const values = raw.map(r => Number(r.total) || 0);
    const ctx = canvas.getContext('2d');

    // Gradient warna (gunakan helper dari app.js kalau ada)
    const bg = (window.chartGradient ? window.chartGradient(ctx, canvas)
             : (function(){
                  const rgb = getComputedStyle(document.documentElement).getPropertyValue('--chart-bar').trim() || '45,156,219';
                  const g = ctx.createLinearGradient(0,0,0,canvas.height);
                  g.addColorStop(0, `rgba(${rgb}, .55)`);
                  g.addColorStop(1, `rgba(${rgb}, .15)`);
                  return g;
               })());

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Pengeluaran (Rp)',
          data: values,
          backgroundColor: bg,
          borderRadius: 8,
          maxBarThickness: 48
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,       // ikut tinggi .chart-box
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: (v)=> 'Rp ' + Number(v).toLocaleString('id-ID') }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: { label: (c)=> 'Rp ' + Number(c.raw).toLocaleString('id-ID') }
          }
        },
        animation: { duration: 800, easing: 'easeOutQuart' }
      }
    });
  } else {
    // Fallback: tidak ada data
    const empty = document.createElement('div');
    empty.className = 'text-muted d-flex align-items-center justify-content-center h-100';
    empty.textContent = 'Tidak ada data pengeluaran pada periode ini.';
    canvas.parentElement.replaceWith(empty);
  }
});
</script>
{% endblock %}
